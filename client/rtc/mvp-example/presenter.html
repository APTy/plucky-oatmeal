<!doctype html>
<html>
  <head>
    <title>Presenter</title>
    <script src="../../lib/angular/angular.js"></script>
    <script src="../../lib/angular-sanitize/angular-sanitize.js"></script>
    <script src="../rtc-normalizer.js"></script>
    <script src="../base-rtc.js"></script>
    <script src="../presenter-rtc.js"></script>
    <script type="text/javascript">
      var addVideoElem = function (url) {
        console.log('adding video!');
        var vid = document.createElement('video');
        vid.muted = true;
        vid.autoplay = true;
        vid.src = url;
        document.getElementById('videos').appendChild(vid);
      };

      angular.module('ribbitPresenterRTC')
        .controller('presenterCtrl', function($scope, $sce, presenterRTC) {
          $scope.connections = [];

          // only connect once our RTC manager is ready!
          presenterRTC.ready(function () {
            // the first arg here is teh room object, the second is who we're connecting as
            presenterRTC.connect({ name: 'aviary', presenter: 'fred'}, 'fred'); 
          });

          // register event handlers for peer connection events. MDN has a description of these events.
          // the remote user and peerconnection object are the last two arguments for any handler
          presenterRTC.on('onaddstream', function (event, remoteUser, pc) {
            // For onaddstream, you need to look in event.stream to get the media stream
            // See audience-1.html for description of trustAsResourceUrl and createObjectURL -- you need both!
            // NOTE: this doesn't yet seem to work when the stream is remote, though I'm pretty sure it should.
            // if you don't go through angular and instead just set the src w/vanillaJS it does work, so things
            // are fine on the RTC side...
            var stream = $sce.trustAsResourceUrl(window.URL.createObjectURL(event.stream));

            //Just testing w/vanillajs here, to make sure the remote stream actually works... angular can be fussy
            addVideoElem(stream);

            var connection = {
              stream: stream,
              user: remoteUser
            };

            $scope.connections.push(connection);

            // must call $scope.$apply so angular knows to run a digest
            $scope.$apply();
          });

        })
        .config(['baseRTCProvider', function(baseRTCProvider) {
          console.log('hey! in the config');

          baseRTCProvider.setSignalServer('ws://localhost:3434'); //normally must be set up by app
          // baseRTCProvider.setSignalServer('ws://307a1d89.ngrok.com'); //normally must be set up by app

          baseRTCProvider.setPeerConnectionConfig({
            'iceServers': [
              {'url': 'stun:stun.services.mozilla.com'}, 
              {'url': 'stun:stun.l.google.com:19302'}
            ]
          });
        }]);


    </script>
  </head>
  <body ng-app="ribbitPresenterRTC" ng-controller="presenterCtrl">
    <h1>Audience Video</h1>
    Connections count: {{connections.length}}
    <div id="videos"></div>
  </body>
</html>